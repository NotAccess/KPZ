# Реализованные функции ETL

## **github_api_get**
```R
github_api_get <- function(url) {
  ...
  return(response)
}
```
Функция отправляет HTTP-запросы к GitHub API с обработкой авторизации и основных ошибок. Поддерживает использование персонального токена для увеличения лимита запросов. Автоматически использует токен из глобальной переменной `GITHUB_TOKEN`, если она установлена.

Входные данные: 
- `url` - URL-адрес для запроса к GitHub API

Выходные данные:
- `response` - ответ от GitHub API при успешном запросе (200)
- `NULL` - для следующих кодов состояния:
   - 204 (No Content)
   - 404 (Not Found)
   - 409 (Conflict)
   - 5xx (Server errors)
- прерывает выполнение с ошибкой (`stop()`) для:
   - 401 (Unauthorized)
   - 403 (Forbidden)
   - Другие необработанные коды ошибок

## **get_user_repos**
```R
get_user_repos <- function(username, setProgress = NULL) {
  ...
  return(repo_data)
}
```
Получение и обработка репозиториев пользователя GitHub. Функция получает список всех репозиториев указанного пользователя GitHub, включая дополнительную метаинформацию (язык, звёзды, участники и т.д.), с поддержкой прогресс-бара для отслеживания выполнения. Она использует API GitHub, разбивает запрос на страницы, если репозиториев много, и возвращает список с информацией о каждом репозитории.

Входные данные: 
- `username` - имя пользователя GitHub
- `setProgress` (необязательный) - функция для обновления прогресс-бара (используется в Shiny). Должна поддерживать параметры: 
   - `message` - текст статуса
   - `value` - текущий прогресс (0-1)
   - `detail` - дополнительные детали

Выходные данные:
- `repo_data` - список с данными о репозиториях пользователя. Каждый элемент содержит: 
   - `username` - логин пользователя
   - `name` - название репозитория
   - `full_name` - полное имя (username/repo)
   - `description` - описание или "Нет описания"
   - `language` - основной язык или "Не указан"
   - `stars` - количество звёзд
   - `forks` - количество форков
   - `created_at` - дата создания
   - `updated_at` - дата обновления
   - `url` - ссылка на репозиторий
   - `open_issues` - количество открытых issues
   - `contributors` - количество контрибьюторов
   - `license` - лицензия или "Нет лицензии"
   - `size` - размер в KB
- `NULL` - если репозитории не найдены.

## **get_user_commits_df**
```R
get_user_commits_df <- function(repos, setProgress = NULL) {
  commits_df <- data.frame(
    id = character(),
    repo = character(),
    author = character(),
    date = as.POSIXct(character()),
    filename = character(),
    status = character(),
    additions = numeric(),
    deletions = numeric(),
    changes = numeric(),
    message = character(),
    branch = character(),  # добавляем поле для ветки
    stringsAsFactors = FALSE
  )
  ...
  return(commits_df)
}
```
Функция извлекает коммиты из списка репозиториев GitHub, включая данные о файлах, авторах и изменениях, с сохранением в DuckDB и поддержкой прогресс-бара.

Особенности:
- Автоматически обрабатывает все ветки каждого репозитория
- Кэширует данные в DuckDB (повторные запросы используют локальную БД)
- Поддерживает пагинацию GitHub API (100 коммитов на страницу)
- Конвертирует даты в локальный часовой пояс

Входные данные: 
- `repos` - список репозиториев (результат `get_user_repos()`)
- `setProgress` (необязательный) - функция для обновления прогресс-бара (используется в Shiny). Должна поддерживать параметры: 
   - `message` - текст статуса
   - `value` - текущий прогресс (0-1)
   - `detail` - дополнительные детали

Выходные данные: 
- `commits_df` - датафрейм с данными о коммитах. Структура:
   - `id` - SHA коммита
   - `patch` - diff-патч (или "NULL")
   - `repo` - полное имя репозитория
   - `author` - имя автора
   - `date` - дата в формате "ГГГГ.ММ.ДД ЧЧ:ММ:СС" (локальное время)
   - `filename` - имя изменённого файла
   - `status` - статус изменения (added, modified, removed)
   - `additions` - количество добавленных строк
   - `deletions` - количество удалённых строк
   - `changes` - общее количество изменений
   - `message` - сообщение коммита
   - `branch` - название ветки
- `NULL` - если коммиты не найдены

## **get_user_profile**
```R
get_user_profile <- function(username) {
  ...
  list(
    name = profile$login,
    bio = profile$bio %||% "Биография не указана",
    avatar_url = profile$avatar_url,
    created_at = profile$created_at,
    updated_at = profile$updated_at,
    company = profile$company,
    location = profile$location,
    followers = profile$followers,
    following = profile$following,
    public_repos = profile$public_repos,
    html_url = profile$html_url,
    blog = profile$blog
  )
}
```
Функция получает основную информацию о пользователе GitHub через API, включая имя, аватар, статистику активности и другие публичные данные.

Особенности:
 - Для работы требуется функция `github_api_get()` (запросы к GitHub API)
 - Автоматически обрабатывает отсутствующие поля (например, bio/company)
 - Данные возвращаются "как есть" от GitHub API (без преобразования дат)

Входные данные: 
- `username` - имя пользователя GitHub 

Выходные данные: 
- список с данными профиля. Структура:
   - `name` - логин пользователя
   - `bio` - краткая биография или "Биография не указана"
   - `avatar_url` - URL аватара
   - `created_at` - дата создания аккаунта (в формате ISO 8601)
   - `updated_at` - дата последнего обновления профиля
   - `company` - название компании или NULL
   - `location` - местоположение или NULL
   - `followers` - количество подписчиков
   - `following` - количество подписок
   - `public_repos` - количество публичных репозиториев
   - `blog` - URL блога или NULL
- `NULL` - если пользователь не найден или произошла ошибка запроса.

## **prepare_activity_data**
```R
prepare_activity_data <- function(repos) {
  ...
  return(activity_data)
}
```

Функция преобразует список репозиториев GitHub в структурированные данные для визуализации активности (issues и forks) по датам.

Входные данные:
- `repos` - список репозиториев, полученный из `get_user_repos()`. Каждый элемент списка должен содержать:
   - `created_at` - дата создания репозитория (в формате, конвертируемом в Date)
   - `updated_at` - Дата последнего обновления
   - `open_issues` - количество открытых issues
   - `forks` - количество форков

Выходные данные:
- `activity_data` - датафрейм в "длинном" формате с колонками:
   - `date` - Дата (Date)}
   - `count` - Числовое значение (issues или forks)}
   - `type` - Тип активности ("Issues" или "Forks")}
- `NULL` - если входной список пуст.

## **prepare_language_data**
```R
prepare_language_data <- function(repos) {
  ...
  return(language_data)
}
```

Функция анализирует список репозиториев GitHub и возвращает статистику использования языков программирования.

Особенности:
- Репозитории без указанного языка (`language = NULL`) игнорируются
- Результат отсортирован по количеству репозиториев (по убыванию)

Входные данные: 
- `repos` - список репозиториев, полученный из `get_user_repos()`. Каждый элемент списка должен содержать поле `language` (строка с названием языка программирования или NULL, если язык не указан).

Выходные данные:
- `language_data` - датафрейм с двумя колонками:
   - `language` - название языка программирования (factor)
   - `count` - количество репозиториев на этом языке (integer)
- `NULL` - если входной список пуст или ни в одном репозитории не указан язык программирования.

## **prepare_commit_heatmap_data**
```R
prepare_commit_heatmap_data <- function(commits) {
  ...
  return(heatmap_data)
}
```
Функция преобразует данные о коммитах в формат, пригодный для построения тепловой карты активности по дням недели и часам.

Особенности:
- Удаляет дубликаты коммитов по полю `id`
- Конвертирует даты в POSIXct (UTC)
- Фильтрует записи с NA в дате
- Группирует коммиты по часам и дням недели
- Поддерживает русские названия дней недели

Входные данные: 
- `commits` - датафрейм с коммитами, полученный из `get_user_commits_df()`. Должен содержать колонки:
   - `id` - уникальный идентификатор коммита
   - `date` - дата и время коммита (в формате "ГГГГ.ММ.ДД ЧЧ:ММ")

Выходные данные: 
- `heatmap_data` - датафрейм с тремя колонками:
   - `hour` - Час дня (0-23, integer)}
   - `day` - День недели (factor с уровнями от понедельника до воскресенья)}
   - `count` - Количество коммитов (integer)}
- `NULL` - если входные данные пусты или не содержат валидных дат.