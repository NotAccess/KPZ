---
title: "GitHub Analytics Report"
author: "GitHub Analytics App"
date: "{R} format(Sys.time(), '%d %B %Y')"
output: 
  pdf_document:
    toc: true
    toc_depth: 2
    number_sections: true
params:
  profile: null
  repos: null
  commits: null
---
```{R} setup, include=FALSE
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(knitr)
library(ggplot2)
library(dplyr)
```

# Основная информация пользователя {R} params$profile$name

```{R} user-info
# Скачиваем аватар
avatar_path <- tempfile(fileext = ".jpg")
download.file(params$profile$avatar_url, avatar_path, mode = "wb")

# Основная информация
cat("Дата регистрации:", format(as.Date(params$profile$created_at), "%d.%m.%Y"), "\n\n")
cat("Подписчики:", params$profile$followers, "\n\n")
cat("Подписки:", params$profile$following, "\n\n")
cat("Публичные репозитории:", params$profile$public_repos, "\n\n")
cat("Локация:", ifelse(is.null(params$profile$location), "Не указана", params$profile$location), "\n\n")
```

```{R} avatar, out.width='200px'
# Вставляем аватар
knitr::include_graphics(avatar_path)
```

# Статистика репозиториев

```{R} repos-stats
repos_df <- bind_rows(params$repos)

stats <- list(
  "Среднее звёзд" = mean(repos_df$stars),
  "Среднее форков" = mean(repos_df$forks),
  "Популярный язык" = names(which.max(table(repos_df$language))),
  "Репозиториев с лицензией" = sum(repos_df$license != "Нет лицензии")
)

kable(data.frame(
  Метрика = names(stats),
  Значение = unlist(stats)
), caption = "Основные метрики репозиториев")
```

```{R} repos-plot, fig.height=4
# График распределения языков
ggplot(repos_df, aes(x = language, fill = language)) + 
  geom_bar() +
  labs(title = "Распределение языков программирования", 
       x = "Язык", 
       y = "Количество репозиториев") +
  theme_minimal()
```

# Анализ активности

```{R} activity-stats
if (!is.null(params$commits)) {
  commits <- params$commits %>%
    mutate(date = as.POSIXct(date, format = "%d.%m.%Y %H:%M:%S"))
  
  activity <- list(
    "Всего коммитов" = n_distinct(commits$id),
    "Среднее изменений на коммит" = mean(commits$changes),
    "Самый активный день" = format(as.Date(names(which.max(table(as.Date(commits$date)))), "%d.%m.%Y")
  )
  
  kable(data.frame(
    Метрика = names(activity),
    Значение = unlist(activity)
  ), caption = "Статистика коммитов")
}
```
